@page "/"
@using SVGLClub.Data
@using SVGLClub.Services
@using SVGLClub.Components.Layout

@inject ISessionStateService SessionState;
@inject IConfiguration Configuration;
@inject IContentLoader ContentLoader;

<PageTitle>SVGL - Assetto Corsa</PageTitle>

@if (!_pageLoaded)
{
    <MudContainer Class="d-flex justify-center align-center" Style="height:100vh">
        <MudStack Spacing="2" AlignItems="AlignItems.Center">
            <MudProgressCircular Indeterminate="true" Size="Size.Large"/>
            <MudText Typo="Typo.h6">Loading...</MudText>
        </MudStack>
    </MudContainer>
}
else 
{
    <MudContainer Class="my-6">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-6" Elevation="4">
                    <MudStack Spacing="3">
                        <MudStack>
                            <MudText Typo="Typo.h4" Class="fw-bold">Sick Video Game Lmao</MudText>
                            <MudStack Row="true">
                                <MudStack Row="true">
                                    <MudText Typo="Typo.subtitle2" Class="mt-2">Total Laps Driven: </MudText>
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mt-2">@_totalLaps</MudText>
                                </MudStack>
                                <MudStack Row="true" Class="pl-8">
                                    <MudText Typo="Typo.subtitle2" Class="mt-2">Unique Drivers: </MudText>
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mt-2">@_totalDrivers</MudText>
                                </MudStack>
                            </MudStack>
                        </MudStack>

                        <MudDivider />

                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Class="fw-bold">Current Cars</MudText>

                            <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1">
                                @foreach (string car in _cars)
                                {
                                    <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">@car</MudChip>
                                }
                            </MudStack>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="pa-6 d-flex flex-column justify-space-between" Elevation="4" Style="height:100%;">
                    <MudStack Spacing="3">
                        <MudText Typo="Typo.subtitle2" Class="fw-bold">Current Track</MudText>
                        <MudText Typo="Typo.h5">@_trackName</MudText>
                    </MudStack>

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true" Href="@_connectionUrl" StartIcon="@Icons.Material.Filled.SportsEsports">
                        Join Server
                    </MudButton>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="12">
                <MudPaper Class="pa-6" Elevation="4">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h4" Class="fw-bold">Previous Sessions</MudText>
                        <SessionTabs Sessions="@SessionState.Sessions"></SessionTabs>
                    </MudStack>

                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    private string _connectionUrl = string.Empty;
    private string _trackName = string.Empty;
    private List<string> _cars = new();
    private int _totalDrivers;
    private int _totalLaps;

    private bool _pageLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        await SessionState.EnsureLoadedAsync();
        _connectionUrl = Configuration["ContentManager:ConnectionURL"]!;

        _trackName = ContentLoader.GetDisplayName(SessionState.Config.TrackName + "|" + SessionState.Config.TrackConfig);

        foreach (string car in SessionState.Config.Cars)
        {
            _cars.Add(ContentLoader.GetDisplayName(car));
        }

        _totalDrivers = SessionState.Sessions
            .SelectMany(s => s.Laps ?? Enumerable.Empty<SessionLap>())
            .Select(l => l.DriverGuid)
            .Distinct()
            .Count();

        _totalLaps = SessionState.Sessions
            .Where(s => s.Laps != null)
            .Sum(s => s.Laps!.Count);

        _pageLoaded = true;
        StateHasChanged();
    }
}