@page "/driverstats"

@using SVGLClub.Data
@using SVGLClub.Services
@using SVGLClub.Components.Layout

@inject ISessionStateService SessionState
@inject IDriverStatService DriverStatService

<PageTitle>Driver Stats</PageTitle>

@if (!_pageLoaded) 
{
    <MudContainer Class="d-flex justify-center align-center" Style="height:100vh">
        <MudStack Spacing="2" AlignItems="AlignItems.Center">
            <MudProgressCircular Indeterminate="true" Size="Size.Large"/>
            <MudText Typo="Typo.h6">Loading...</MudText>
        </MudStack>
    </MudContainer>
}
else 
{
    <MudContainer>
        <MudContainer Class="my-4">
            <MudText Typo="Typo.h4">Driver Stats</MudText>
        </MudContainer>

        <MudTabs Outlined="true" Position="Position.Left" Rounded="true" Border="true" ApplyEffectsToContainer="true" Class="my-4" TabPanelsClass="pa-4" Style="background-color:var(--mud-palette-skeleton)">
            @foreach (string driver in _driverStats.Keys)
            {
                <MudTabPanel Text="@_driverStats[driver].DriverName">
                    <MudStack>
                        <DriverStatCards LapCount="@_driverStats[driver].LapCount" FavoriteCar="@_driverStats[driver].FavoriteCar" FavoriteTrack="@_driverStats[driver].FavoriteTrack" />
                        <DriverLapsTable DriverId="@driver" Sessions="SessionState.Sessions" DriverLaps="_driverStats[driver].LapsByTrack" DriverTracks="_driverStats[driver].TracksDriven" />
                    </MudStack>
                </MudTabPanel>
            }
        </MudTabs>
    </MudContainer>
}

@code {
    private Dictionary<string, DriverSummary> _driverStats { get; set; } = new();
    private bool _pageLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        await SessionState.EnsureLoadedAsync();
        _driverStats = DriverStatService.BuildDriverSummaries(SessionState.Sessions);
        _pageLoaded = true;
        StateHasChanged();
    }
}
